name: Build OpenWrt Package

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'OpenWrt SDK 版本 (例如: 23.05.5 或 24.10.1)'
        required: true
        default: '23.05.5'
        type: string

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 (软路由, PC)
          - arch: x86_64
            target: x86/64

          # aarch64_generic (N1, 树莓派4, NanoPi 等 ARMv8 设备)
          - arch: aarch64_generic
            target: armsr/armv8

          # ramips_mt7621 (红米AC2100, K2P, 新路由3 等 MTK7621 设备)
          - arch: ramips_mt7621
            target: ramips/mt7621

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Environment
        run: |
          sudo apt-get update
          # 增加 zstd 以支持新版 SDK 解压
          sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 file zstd

      - name: Download and Setup SDK
        run: |
          # 构建基础下载目录 URL
          BASE_URL="https://downloads.openwrt.org/releases/${{ inputs.sdk_version }}/targets/${{ matrix.target }}/"
          
          echo "Searching for SDK at: $BASE_URL"
          
          # 自动抓取 SDK 文件名
          SDK_FILE=$(wget -q -O - "$BASE_URL" | grep -oE 'openwrt-sdk-[^"]*\.tar\.(xz|zst)' | head -n 1)
          
          if [ -z "$SDK_FILE" ]; then
            echo "::error::Could not find SDK file at $BASE_URL"
            exit 1
          fi
          
          echo "Found SDK file: $SDK_FILE"
          wget -O "sdk_archive" "$BASE_URL/$SDK_FILE"
          
          # 解压 SDK
          mkdir sdk
          if [[ "$SDK_FILE" == *.zst ]]; then
            tar -I zstd -xf sdk_archive -C sdk --strip-components=1
          else
            tar -xf sdk_archive -C sdk --strip-components=1
          fi

      - name: Update Feeds (Fix Network Issues)
        working-directory: ./sdk
        run: |
          # 1. 复制默认配置
          if [ -f "feeds.conf.default" ]; then
            cp feeds.conf.default feeds.conf
          fi
          
          # 2. 关键修复：将 git.openwrt.org 替换为 github.com/openwrt
          # GitHub Actions 访问 GitHub 仓库极快，而访问官方 git 源经常超时
          sed -i 's/git.openwrt.org\/feed/github.com\/openwrt/g' feeds.conf
          sed -i 's/git.openwrt.org\/project/github.com\/openwrt/g' feeds.conf
          
          echo "=== Modified feeds.conf ==="
          cat feeds.conf
          echo "==========================="
          
          # 3. 更新 Feeds
          ./scripts/feeds update -a
          
          # 4. 安装 Feeds (忽略错误)
          # 注意：feeds install -a 经常因为某个无关包(如 telephony)失败导致整个脚本退出
          # 我们这里加上 || true 忽略非关键错误，只要后续编译能找到依赖就行
          ./scripts/feeds install -a || true
          
          # 5. 显式安装必要的依赖包，确保编译所需的依赖存在
          ./scripts/feeds install python3-light python3-logging python3-codecs python3-ctypes python3-email python3-urllib python3-uuid luci-base luci-compat luci-mod-admin-full || true
          
          # 6. 生成默认配置
          make defconfig

      - name: Add Package to SDK
        working-directory: ./sdk
        run: |
          # 将仓库中的 tlsfragment 和 luci-app-tlsfragment 复制到 SDK 的 package 目录
          cp -r $GITHUB_WORKSPACE/tlsfragment package/
          cp -r $GITHUB_WORKSPACE/luci-app-tlsfragment package/
          
      - name: Compile Packages
        working-directory: ./sdk
        run: |
          # 编译
          echo "Starting Compile..."
          # 尝试编译，如果因为依赖问题失败，不要立即退出，查看输出
          make package/tlsfragment/compile V=s
          make package/luci-app-tlsfragment/compile V=s
          
          # 检查是否生成了 ipk
          find bin -name "*.ipk"

      - name: Organize Artifacts
        run: |
          mkdir -p bin/packages
          # 查找生成的 ipk 文件
          find sdk/bin -name "tlsfragment*.ipk" -exec cp {} bin/packages/ \;
          find sdk/bin -name "luci-app-tlsfragment*.ipk" -exec cp {} bin/packages/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tlsfragment-${{ matrix.arch }}-${{ inputs.sdk_version }}
          path: bin/packages/*.ipk