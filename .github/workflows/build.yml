name: Build OpenWrt Package

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'OpenWrt SDK 版本 (例如: 23.05.5 或 24.10.1)'
        required: true
        default: '23.05.5'
        type: string

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 (软路由, PC)
          - arch: x86_64
            target: x86/64

          # aarch64_generic (N1, 树莓派4, NanoPi 等 ARMv8 设备)
          - arch: aarch64_generic
            target: armsr/armv8

          # ramips_mt7621 (红米AC2100, K2P, 新路由3 等 MTK7621 设备)
          - arch: ramips_mt7621
            target: ramips/mt7621

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Environment
        run: |
          sudo apt-get update
          # 增加 zstd 以支持新版 SDK 解压
          sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 file zstd

      - name: Download and Setup SDK
        run: |
          # 构建基础下载目录 URL
          BASE_URL="https://downloads.openwrt.org/releases/${{ inputs.sdk_version }}/targets/${{ matrix.target }}/"
          
          echo "Searching for SDK at: $BASE_URL"
          
          # 自动抓取 SDK 文件名
          # grep -E 同时匹配 .tar.xz 和 .tar.zst
          SDK_FILE=$(wget -q -O - "$BASE_URL" | grep -oE 'openwrt-sdk-[^"]*\.tar\.(xz|zst)' | head -n 1)
          
          if [ -z "$SDK_FILE" ]; then
            echo "::error::Could not find SDK file at $BASE_URL"
            echo "Possible reasons:"
            echo "1. The version '${{ inputs.sdk_version }}' does not exist."
            echo "2. The target '${{ matrix.target }}' path is different in this version."
            exit 1
          fi
          
          echo "Found SDK file: $SDK_FILE"
          
          # 下载文件
          wget -O "sdk_archive" "$BASE_URL/$SDK_FILE"
          
          # 解压 SDK
          mkdir sdk
          if [[ "$SDK_FILE" == *.zst ]]; then
            echo "Detected ZST compression..."
            tar -I zstd -xf sdk_archive -C sdk --strip-components=1
          else
            echo "Detected XZ compression..."
            tar -xf sdk_archive -C sdk --strip-components=1
          fi
          
          cd sdk
          
          # 更新 Feeds (获取依赖如 python3, lua 等)
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # 准备 .config
          make defconfig

      - name: Add Package to SDK
        run: |
          cd sdk/package
          # 将仓库中的 tlsfragment 和 luci-app-tlsfragment 复制到 SDK 的 package 目录
          cp -r $GITHUB_WORKSPACE/tlsfragment .
          cp -r $GITHUB_WORKSPACE/luci-app-tlsfragment .
          
          # 检查文件结构
          ls -R tlsfragment
          ls -R luci-app-tlsfragment

      - name: Compile Packages
        working-directory: ./sdk
        run: |
          # 开启 V=s 查看详细日志以便排错
          echo "Compiling tlsfragment..."
          make package/tlsfragment/compile V=s
          
          echo "Compiling luci-app-tlsfragment..."
          make package/luci-app-tlsfragment/compile V=s

      - name: Organize Artifacts
        run: |
          mkdir -p bin/packages
          # 查找生成的 ipk 文件
          find sdk/bin -name "tlsfragment*.ipk" -exec cp {} bin/packages/ \;
          find sdk/bin -name "luci-app-tlsfragment*.ipk" -exec cp {} bin/packages/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tlsfragment-${{ matrix.arch }}-${{ inputs.sdk_version }}
          path: bin/packages/*.ipk