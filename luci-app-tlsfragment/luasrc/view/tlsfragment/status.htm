<div class="cbi-value-field">
	<table id="status-table" style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
		<tr>
			<td style="text-align: right; padding-right: 8px; white-space: nowrap; width: 1%;"><strong><%:Service Status%>:</strong></td>
			<td style="text-align: left;">
				<span id="status-running" class="label"><%:Loading%>...</span>
			</td>
			<td style="text-align: right; padding-right: 8px; padding-left: 20px; white-space: nowrap; width: 1%;"><strong><%:Configuration%>:</strong></td>
			<td style="text-align: left;">
				<span id="status-enabled" class="label"><%:Loading%>...</span>
			</td>
		</tr>
		<tr>
			<td style="text-align: right; padding-right: 8px; white-space: nowrap;"><strong><%:Listen Port%>:</strong></td>
			<td id="status-port" style="text-align: left;">-</td>
			<td style="text-align: right; padding-right: 8px; padding-left: 20px; white-space: nowrap;"><strong><%:Mode%>:</strong></td>
			<td id="status-mode" style="text-align: left;">-</td>
		</tr>
		<tr id="pid-row" style="display: none;">
			<td style="text-align: right; padding-right: 8px; white-space: nowrap;"><strong><%:Process ID%>:</strong></td>
			<td id="status-pid" colspan="3" style="text-align: left;">-</td>
		</tr>
	</table>
	
	<div class="btn-group" id="control-buttons">
		<button class="btn btn-small" onclick="refreshStatus()">
			<i class="icon-refresh"></i> <%:Refresh Status%>
		</button>
		<button id="btn-start" class="btn btn-small btn-success" style="display: none;" onclick="serviceControl('start')">
			<i class="icon-play"></i> <%:Start Service%>
		</button>
		<button id="btn-stop" class="btn btn-small btn-danger" style="display: none;" onclick="serviceControl('stop')">
			<i class="icon-stop"></i> <%:Stop Service%>
		</button>
		<button id="btn-restart" class="btn btn-small btn-primary" style="display: none;" onclick="serviceControl('restart')">
			<i class="icon-repeat"></i> <%:Restart Service%>
		</button>
		<button class="btn btn-small" onclick="showLogs()">
			<i class="icon-list"></i> <%:View Logs%>
		</button>
	</div>
	<div id="status-message" style="margin-top: 8px; display: none;"></div>
</div>

<script type="text/javascript">
(function() {
	var baseUrl = window.location.pathname.replace(/\/+$/, '');
	var statusUrl = baseUrl + '/status';
	var controlUrl = baseUrl + '/control';
	var logUrl = baseUrl + '/log';
	var token = '<%=token%>';
	
	function updateUI(data) {
		var runningEl = document.getElementById('status-running');
		var enabledEl = document.getElementById('status-enabled');
		var portEl = document.getElementById('status-port');
		var modeEl = document.getElementById('status-mode');
		var pidRow = document.getElementById('pid-row');
		var pidEl = document.getElementById('status-pid');
		var btnStart = document.getElementById('btn-start');
		var btnStop = document.getElementById('btn-stop');
		var btnRestart = document.getElementById('btn-restart');
		
		if (data.running) {
			runningEl.className = 'label label-success';
			runningEl.textContent = '<%:Running%>';
			btnStart.style.display = 'none';
			btnStop.style.display = '';
			btnRestart.style.display = '';
			pidRow.style.display = '';
		} else {
			runningEl.className = 'label label-important';
			runningEl.textContent = '<%:Stopped%>';
			btnStart.style.display = '';
			btnStop.style.display = 'none';
			btnRestart.style.display = 'none';
			pidRow.style.display = 'none';
		}
		
		if (data.enabled) {
			enabledEl.className = 'label label-info';
			enabledEl.textContent = '<%:Enabled%>';
		} else {
			enabledEl.className = 'label label-warning';
			enabledEl.textContent = '<%:Disabled%>';
		}
		
		portEl.textContent = data.port || '-';
		modeEl.textContent = data.mode || '-';
		
		if (data.pid) {
			pidEl.textContent = data.pid;
		} else if (data.port_listening) {
			pidEl.textContent = '<%:Listening on port%> ' + data.port;
		} else {
			pidEl.textContent = '-';
		}
	}
	
	function showMessage(msg, isError) {
		var el = document.getElementById('status-message');
		el.style.display = 'block';
		el.className = isError ? 'alert alert-error' : 'alert alert-success';
		el.textContent = msg;
		setTimeout(function() { el.style.display = 'none'; }, 3000);
	}
	
	function setButtonsLoading(loading) {
		var buttons = document.querySelectorAll('#control-buttons button');
		for (var i = 0; i < buttons.length; i++) {
			buttons[i].disabled = loading;
		}
	}
	
	window.refreshStatus = function() {
		var xhr = new XMLHttpRequest();
		xhr.open('GET', statusUrl, true);
		xhr.onreadystatechange = function() {
			if (xhr.readyState === 4) {
				console.log('Status response:', xhr.status, xhr.responseText.substring(0, 200));
				if (xhr.status === 200) {
					try {
						var data = JSON.parse(xhr.responseText);
						updateUI(data);
					} catch (e) {
						console.error('Failed to parse status:', e);
						document.getElementById('status-running').textContent = 'Error: ' + e.message;
					}
				} else {
					document.getElementById('status-running').textContent = 'HTTP ' + xhr.status;
				}
			}
		};
		xhr.send();
	};
	
	window.serviceControl = function(action) {
		setButtonsLoading(true);
		var xhr = new XMLHttpRequest();
		xhr.open('POST', controlUrl, true);
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.onreadystatechange = function() {
			if (xhr.readyState === 4) {
				setButtonsLoading(false);
				if (xhr.status === 200) {
					try {
						var result = JSON.parse(xhr.responseText);
						var msg = result.message;
						// 翻译消息
						var translations = {
							'Service started': '<%:Service started%>',
							'Service stopped': '<%:Service stopped%>',
							'Service restarted': '<%:Service restarted%>',
							'Service enabled': '<%:Service enabled%>',
							'Service disabled': '<%:Service disabled%>',
							'Invalid action': '<%:Invalid action%>'
						};
						if (translations[msg]) msg = translations[msg];
						showMessage(msg, !result.success);
					} catch (e) {}
				}
				// 延迟刷新状态，等待服务启动/停止
				setTimeout(refreshStatus, 500);
			}
		};
		xhr.send('token=' + token + '&action=' + action);
	};
	
	window.showLogs = function() {
		window.open(logUrl, '_blank', 'width=800,height=600,scrollbars=yes');
	};
	
	// 页面加载时立即获取状态
	refreshStatus();
})();
</script>
